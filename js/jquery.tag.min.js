(function(a){a.extend(a.fn,{tag:function(b){var c={minWidth:100,minHeight:100,defaultWidth:100,defaultHeight:100,maxHeight:null,maxWidth:null,save:null,remove:null,canTag:true,canDelete:true,autoShowDrag:false,autoComplete:null,defaultTags:null,clickToTag:true,draggable:true,resizable:true,showTag:"hover",debug:false};var b=a.extend(c,b);return this.each(function(){var d=a(this);d.data("options",b);a(window).load(function(){d.wrap('<div class="jTagArea" />');a('<div class="jTagOverlay"></div>').insertBefore(d);d.parent().css("backgroundImage","url("+d.attr("src")+")");d.parent().width(d.width());d.parent().height(d.height());d.hide();if(b.autoShowDrag){d.showDrag()}a(".jTagTag").live("mouseenter",function(){if(a(".jTagDrag").length==0){a(this).css("opacity",1);a(this).find("span").show();d.disableClickToTag()}});a(".jTagTag").live("mouseleave",function(){if(a(".jTagDrag").length==0){if(b.showTag=="hover"){a(this).css("opacity",0);a(this).find("span").hide()}d.enableClickToTag()}});if(b.canDelete){a(".jTagDeleteTag").live("click",function(){if(b.remove){b.remove(a(this).parent().parent().getId())}d.enableClickToTag();a(this).parent().parent().remove()})}if(b.defaultTags){a.each(b.defaultTags,function(e,f){d.addTag(f.width,f.height,f.top,f.left,f.label,f.id)})}d.enableClickToTag()})})},hideDrag:function(){obj=a(this);var b=obj.data("options");a(".jTagOverlay").removeClass("jTagPngOverlay");a(".jTagDrag").remove();if(b.showTag=="always"){a(".jTagTag").show()}obj.enableClickToTag()},showDrag:function(f){obj=a(this);obj.disableClickToTag();var d=obj.data("options");var b=function(){border=parseInt(a(".jTagDrag").css("borderTopWidth"));left_pos=parseInt(a(".jTagDrag").attr("offsetLeft"))+border;top_pos=parseInt(a(".jTagDrag").attr("offsetTop"))+border;return"-"+left_pos+"px -"+top_pos+"px"};if(a(".jTagDrag").length==1){return}if(!d.canTag){return}if(d.showTag=="always"){a(".jTagTag").hide()}a('<div style="width:'+d.defaultWidth+"px;height:"+d.defaultHeight+'px"class="jTagDrag"><div class="jTagSave"><div class="jTagInput"><input type="text" id="jTagLabel"></div><div class="jTagSaveClose"></div><div class="jTagSaveBtn"></div><div style="clear:both"></div></div>').appendTo(a(".jTagOverlay"));a(".jTagOverlay").addClass("jTagPngOverlay");a(".jTagDrag").css("backgroundImage","url("+obj.attr("src")+")");if(f){function c(e){var g=curtop=0;if(e.offsetParent){do{g+=e.offsetLeft;curtop+=e.offsetTop}while(e=e.offsetParent);return[g,curtop]}}pos=c(obj.parent()[0]);x=Math.max(0,f.pageX-pos[0]-(d.defaultWidth/2));y=Math.max(0,f.pageY-pos[1]-(d.defaultHeight/2));if(x+a(".jTagDrag").width()>obj.parent().width()){x=obj.parent().width()-a(".jTagDrag").width()-2}if(y+a(".jTagDrag").height()>obj.parent().height()){y=obj.parent().height()-a(".jTagDrag").height()-2}}else{x=0;y=0}a(".jTagDrag").css("top",y).css("left",x);if(d.autoComplete){a("#jTagLabel").autocomplete({source:d.autoComplete})}a(".jTagSaveBtn").click(function(){label=a("#jTagLabel").val();if(label==""){alert("The label cannot be empty");return}height=a(this).parent().parent().height();width=a(this).parent().parent().width();top_pos=a(this).parent().parent().attr("offsetTop");left=a(this).parent().parent().attr("offsetLeft");tagobj=obj.addTag(width,height,top_pos,left,label);if(d.save){d.save(width,height,top_pos,left,label,tagobj)}});a(".jTagSaveClose").click(function(){obj.hideDrag()});if(d.resizable){a(".jTagDrag").resizable({containment:obj.parent(),minWidth:d.minWidth,minHeight:d.minHeight,maxWidht:d.maxWidth,maxHeight:d.maxHeight,resize:function(){a(".jTagDrag").css({backgroundPosition:b()})},stop:function(){a(".jTagDrag").css({backgroundPosition:b()})}})}if(d.draggable){a(".jTagDrag").draggable({containment:obj.parent(),drag:function(){a(".jTagDrag").css({backgroundPosition:b()})},stop:function(){a(".jTagDrag").css({backgroundPosition:b()})}})}a(".jTagDrag").css({backgroundPosition:b()})},addTag:function(f,c,b,g,e,h){obj=a(this);var d=obj.data("options");tag=a('<div class="jTagTag" style="width:'+f+"px;height:"+c+"px;top:"+b+"px;left:"+g+'px;"><div style="width:100%;height:100%"><div class="jTagDeleteTag"></div><span>'+e+"</span></div></div>").appendTo(a(".jTagOverlay"));if(h){tag.setId(h)}if(d.canDelete){obj.parent().find(".jTagDeleteTag").show()}if(d.showTag=="always"){a(".jTagTag").css("opacity",1)}obj.hideDrag();return tag},setId:function(b){if(a(this).hasClass("jTagTag")){a(this).data("tagid",b)}else{alert("Wrong object")}},getId:function(b){if(a(this).hasClass("jTagTag")){return a(this).data("tagid")}else{alert("Wrong object")}},enableClickToTag:function(){obj=a(this);var b=obj.data("options");if(b.clickToTag){obj.parent().mousedown(function(c){obj.showDrag(c);obj.parent().unbind("mousedown")})}},disableClickToTag:function(){obj=a(this);var b=obj.data("options");if(b.clickToTag){obj.parent().unbind("mousedown")}}})})(jQuery);